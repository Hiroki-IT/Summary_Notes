

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>データベースの操作 &mdash; sphinx-tech-notebook 1.0.0 ドキュメント</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="Malwareとサイバー攻撃" href="MalwareAndCyberAttacks.html" />
    <link rel="prev" title="CQRS" href="CQRS.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> sphinx-tech-notebook
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">はじめに：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="AboutThisSite.html">このサイトについて</a></li>
</ul>
<p class="caption"><span class="caption-text">PHP：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ObjectOrientedAnalysisAndDesign.html">オブジェクト指向分析と設計</a></li>
<li class="toctree-l1"><a class="reference internal" href="ObjectOrientedProgramming.html">オブジェクト指向プログラミング</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConceptAndImplementationOfRESTfulAPI.html">RESTful APIの概念と実装</a></li>
<li class="toctree-l1"><a class="reference internal" href="Testing.html">テストの手法</a></li>
<li class="toctree-l1"><a class="reference internal" href="FrameworkAndLibrary.html">フレームワークとライブラリ</a></li>
<li class="toctree-l1"><a class="reference internal" href="MainAlgorithm.html">代表的なアルゴリズム</a></li>
</ul>
<p class="caption"><span class="caption-text">アーキテクチャ：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="DomainDrivenDesign.html">ドメイン駆動設計</a></li>
<li class="toctree-l1"><a class="reference internal" href="CQRS.html">CQRS</a></li>
</ul>
<p class="caption"><span class="caption-text">データベース：</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">データベースの操作</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#rdb">01-01. RDB（関係データベース）とは</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-rdbms">:pushpin: RDBMS（関係データベース管理システム）の仕組み</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-rdbmsrdb">:pushpin: RDBMSとRDBの種類</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mariadb">・MariaDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mysql">・MySQL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#postgresql">・PostgreSQL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-rdbs">:pushpin: RDBSにおけるデータベースエンジン</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#innodb">・InnoDB</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nosql">01-02. NoSQL（非関係データベース）とは</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-nosql">:pushpin: NoSQLの種類</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id2">01-03. RDBの設計</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-uml">:pushpin: UMLによる設計</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-er-entity-relation-diagram">:pushpin: ER図による設計：Entity Relation Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id3">01-04. テーブルの作成</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin">:pushpin: データを追加するあるいは削除する場合の注意点</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">:pushpin: 非正規形の正規化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">02-01. RDBに必要な機能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-acid">:pushpin: ACID特性</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#atomicity">・Atomicity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#consistency">・Consistency</a></li>
<li class="toctree-l4"><a class="reference internal" href="#isolation">・Isolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#durability">・Durability</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">02-02. コミットメント制御と障害回復制御</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-rdb">:pushpin: RDBの操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">:pushpin: ログファイルへの更新前ログの書き込み</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">:pushpin: コミットによるログファイルへの更新前ログへの書き込み</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">・コミット</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">・二相コミット</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">:pushpin: チェックポイントにおけるデータファイルへの書き込み</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">:pushpin: システム障害からの回復</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">・ロールバック</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">・ロールフォワード</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">:pushpin: 媒体障害からの回復</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id16">02-03. 排他制御</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id17">:pushpin: なぜ排他制御が必要か</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id18">・排他制御を行った結果</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id19">:pushpin: 排他制御におけるロックの種類</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id20">・専有ロック</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id21">:pushpin: ロックの粒度</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">:pushpin: デッドロック現象</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id23">・共有ロックしたデータを共有ロック</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">・共有ロックしたデータを専有ロック</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">・専有ロックしたデータを共有ロック</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">・専有ロックしたデータを専有ロック</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create">03-01. <code class="docutils literal notranslate"><span class="pre">create</span></code>によるテーブルの作成</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-primary-key">:pushpin: Primary key（主キー）制約と複合主キー制約</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-not-null">:pushpin: Not Null制約</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-foreign-key">:pushpin: Foreign key（外部キー）と参照制約</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id27">・親テーブルに存在しない値は，子テーブルに登録できない．</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">・親テーブルで参照される値は，子テーブルからは削除できない．</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-stored-procedure">:pushpin: stored procedure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#insert">03-02. <code class="docutils literal notranslate"><span class="pre">insert</span></code>によるデータ行の入力</a></li>
<li class="toctree-l2"><a class="reference internal" href="#migration">03-03. <code class="docutils literal notranslate"><span class="pre">migration</span></code>によるデータベースの更新</a></li>
<li class="toctree-l2"><a class="reference internal" href="#select">04-01. <code class="docutils literal notranslate"><span class="pre">select</span></code>によるデータセットの取得</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">:pushpin: 実装例で用いた略号</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-sql">:pushpin: SQLの処理の順番</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-join">:pushpin: <code class="docutils literal notranslate"><span class="pre">join</span></code>（結合）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-left-join">:pushpin: <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">join</span></code>（左外部結合）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-inner-join">:pushpin: <code class="docutils literal notranslate"><span class="pre">inner</span> <span class="pre">join</span></code>（内部結合）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#where">・内部結合に<code class="docutils literal notranslate"><span class="pre">where</span></code>を用いる場合</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inner-join-on">・内部結合に<code class="docutils literal notranslate"><span class="pre">inner</span> <span class="pre">join</span> <span class="pre">on</span></code>を用いる場合（本試験では出題されない）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id30">:pushpin: 集合関数まとめ</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sum">・<code class="docutils literal notranslate"><span class="pre">sum()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#avg">・<code class="docutils literal notranslate"><span class="pre">avg()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#min">・<code class="docutils literal notranslate"><span class="pre">min()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#max">・<code class="docutils literal notranslate"><span class="pre">max()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#count">・<code class="docutils literal notranslate"><span class="pre">count()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-in">:pushpin: <code class="docutils literal notranslate"><span class="pre">in</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-group-by">:pushpin: <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id31">・集合関数との組み合わせ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-having">:pushpin: <code class="docutils literal notranslate"><span class="pre">having</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-sub-query">:pushpin: sub-query</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-inany">:pushpin: <code class="docutils literal notranslate"><span class="pre">in</span></code>と<code class="docutils literal notranslate"><span class="pre">any</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#in">・<code class="docutils literal notranslate"><span class="pre">in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#any">・<code class="docutils literal notranslate"><span class="pre">any</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-view">:pushpin: <code class="docutils literal notranslate"><span class="pre">view</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-wildcard">:pushpin: <code class="docutils literal notranslate"><span class="pre">wildcard</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-between">:pushpin: <code class="docutils literal notranslate"><span class="pre">between</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">:pushpin: 変数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33">:pushpin: プレースホルダー</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fetch">04-02. <code class="docutils literal notranslate"><span class="pre">fetch</span></code>によるデータ行の取得</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-php">:pushpin: PHPの場合</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pushpin-java">:pushpin: Javaの場合</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id34">05-01. レコードの突き合わせ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id35">:pushpin: 突き合わせ処理とは</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">:pushpin: 突き合わせ処理のアルゴリズム</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">セキュリティ：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="MalwareAndCyberAttacks.html">Malwareとサイバー攻撃</a></li>
<li class="toctree-l1"><a class="reference internal" href="EncryptionTechnology.html">暗号化技術</a></li>
</ul>
<p class="caption"><span class="caption-text">ネットワーク：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="HowTheInternetWorks.html">ネットワークの仕組み</a></li>
<li class="toctree-l1"><a class="reference internal" href="OnPremisesAndCloudComputing.html">オンプレミスとクラウドコンピューティング</a></li>
</ul>
<p class="caption"><span class="caption-text">仮想化技術：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ComparisonOfVirtualizationTechnologies.html">仮想化技術の比較</a></li>
<li class="toctree-l1"><a class="reference internal" href="CreationOfVirtualServer(VirtualMachine)AndContainer.html">仮想サーバ(仮想マシン)とコンテナの構築</a></li>
</ul>
<p class="caption"><span class="caption-text">ソフトウェアとハードウェアの連携：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="WhatIsSoftware.html">ソフトウェアとは</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhatIsHardware.html">ハードウェアとは</a></li>
</ul>
<p class="caption"><span class="caption-text">ハードウェアに対する命令：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="MachineLanguageAndRadix.html">機械語と進数</a></li>
</ul>
<p class="caption"><span class="caption-text">組み込み機器：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="EmbeddedSystem.html">組み込み機器</a></li>
</ul>
<p class="caption"><span class="caption-text">システム開発：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="SystemDevelopmentFlow.html">システム開発の流れ</a></li>
</ul>
<p class="caption"><span class="caption-text">JavaScript：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="PrototypeBasedObjectOriented.html">プロトタイプベースのオブジェクト指向</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementationOnTheFrontSide.html">イベント発火 〜 Webページ表示</a></li>
</ul>
<p class="caption"><span class="caption-text">R言語：</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="StatisticalAnalysis.html">統計解析</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">sphinx-tech-notebook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>データベースの操作</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/OperatingDatabase.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>データベースの操作<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="rdb">
<h2>01-01. RDB（関係データベース）とは<a class="headerlink" href="#rdb" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin-rdbms">
<h3>:pushpin: RDBMS（関係データベース管理システム）の仕組み<a class="headerlink" href="#pushpin-rdbms" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RDBは，データ同士がテーブル状に関係をもつデータ格納形式である．データはストレージに保存する．</p>
<p><img alt="データベース管理システムの仕組み" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF.png" /></p>
</div>
<div class="section" id="pushpin-rdbmsrdb">
<h3>:pushpin: RDBMSとRDBの種類<a class="headerlink" href="#pushpin-rdbmsrdb" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="DBMS" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/DBMS.jpg" /></p>
<div class="section" id="mariadb">
<h4>・MariaDB<a class="headerlink" href="#mariadb" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>MariaDBデータベースを管理できるRDBMS</p>
</div>
<div class="section" id="mysql">
<h4>・MySQL<a class="headerlink" href="#mysql" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>MySQLデータベースを管理できるRDBMS</p>
</div>
<div class="section" id="postgresql">
<h4>・PostgreSQL<a class="headerlink" href="#postgresql" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>PostgreSQLデータベースを管理できるRDBMS</p>
</div>
</div>
<div class="section" id="pushpin-rdbs">
<h3>:pushpin: RDBSにおけるデータベースエンジン<a class="headerlink" href="#pushpin-rdbs" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RDBMSがデータベースに対してデータのCRUDの処理を行うために必要なソフトウェアのこと．</p>
<div class="section" id="innodb">
<h4>・InnoDB<a class="headerlink" href="#innodb" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="nosql">
<h2>01-02. NoSQL（非関係データベース）とは<a class="headerlink" href="#nosql" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>NoSQLは，データ同士が関係を持たないデータ格納形式である．データをメインメモリに保存する．</p>
<div class="section" id="pushpin-nosql">
<h3>:pushpin: NoSQLの種類<a class="headerlink" href="#pushpin-nosql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="NoSQLの分類" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/NoSQL%E3%81%AE%E7%A8%AE%E9%A1%9E.jpg" /></p>
</div>
</div>
<div class="section" id="id2">
<h2>01-03. RDBの設計<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin-uml">
<h3>:pushpin: UMLによる設計<a class="headerlink" href="#pushpin-uml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>16章を参照．Squidの設計図では，UMLとER図を組み合わせている．</p>
</div>
<div class="section" id="pushpin-er-entity-relation-diagram">
<h3>:pushpin: ER図による設計：Entity Relation Diagram<a class="headerlink" href="#pushpin-er-entity-relation-diagram" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>16章を参照．Squidの設計図では，UMLとER図を組み合わせている．</p>
</div>
</div>
<div class="section" id="id3">
<h2>01-04. テーブルの作成<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin">
<h3>:pushpin: データを追加するあるいは削除する場合の注意点<a class="headerlink" href="#pushpin" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データを追加するあるいは削除する場合，カラムではなく，レコードの増減を行う．カラムの増減の処理には時間がかかる．一方で，レコードの増減の処理には時間がかからない．</p>
<p><img alt="カラムの増減は✖，レコードの増減は〇" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E5%A2%97%E6%B8%9B%E3%81%AF%E2%9C%96%EF%BC%8C%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%A2%97%E6%B8%9B%E3%81%AF%E3%80%87-1.png" /></p>
<p><strong>【具体例】</strong></p>
<p>賞与を年1回から，2回・3回と変える場合，主キーを繰り返し，新しく賞与区分と金額区分を作る．</p>
<p><img alt="カラムの増減は✖，レコードの増減は〇-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E5%A2%97%E6%B8%9B%E3%81%AF%E2%9C%96%EF%BC%8C%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%A2%97%E6%B8%9B%E3%81%AF%E3%80%87-2.png" /></p>
</div>
<div class="section" id="id4">
<h3>:pushpin: 非正規形の正規化<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>繰り返し要素のある表を『正規形』，その逆を『非正規形』という．非正規形の表から，他と連動するカラムを独立させ，正規形の表に変更することを『正規化』という．</p>
<p><strong>【具体例1】</strong></p>
<p>まず，主キーが受注Noと商品IDの2つであることを確認．これらの主キーは，複合主キーではないとする．</p>
<ol>
<li><p><strong>エクセルで表を作成</strong></p>
<p>エクセルで作られた以下の表があると仮定．</p>
</li>
</ol>
<p><img alt="非正規形" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E9%9D%9E%E6%AD%A3%E8%A6%8F%E5%BD%A2.png" /></p>
<ol>
<li><p><strong>第一正規化（繰り返し要素の排除）</strong></p>
<p>レコードを1つずつに分割．</p>
<p><img alt="第一正規形" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%B8%80%E6%AD%A3%E8%A6%8F%E5%BD%A2.png" /></p>
</li>
<li><p><strong>第二正規化（主キーの関数従属性を排除）</strong></p>
<p>主キーと特定のカラムが連動する（関数従属性がある）場合，カラムを左表として独立させる．今回，主キーが2つあるので，まず受注Noから関数従属性を排除していく．受注Noと他3カラムが連動しており，左表として独立させる．主キーと連動していたカラムを除いたものを右表とする．また，主キーが重複するローを削除する．</p>
<p><img alt="第二正規形-1" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%BA%8C%E6%AD%A3%E8%A6%8F%E5%BD%A2-1.png" /></p>
<p>次に，商品IDの関数従属性を排除していく．商品IDと他2カラムに関数従属性があり，左表として独立させる．主キーと連動していたカラムを除いたものを右表とする．また，主キーが重複するローを削除する．これで，主キーの関数従属性の排除は終了．</p>
<p><img alt="第二正規形-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%BA%8C%E6%AD%A3%E8%A6%8F%E5%BD%A2-2.png" /></p>
<p><img alt="第二正規形-3" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%BA%8C%E6%AD%A3%E8%A6%8F%E5%BD%A2-3.png" /></p>
</li>
<li><p><strong>第三正規化（主キー以外のカラムの関数従属性を排除）</strong></p>
<p>次に主キー以外のカラムの関係従属性を排除していく．上記で独立させた3つの表のうち，一番左の表で，顧客IDと顧客名に関数従属性があるので，顧客IDを新しい主キーに設定し，左表として独立させる．主キーと連動していたカラムを除いたものを右表とする．</p>
</li>
</ol>
<p><img alt="第三正規形" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%B8%89%E6%AD%A3%E8%A6%8F%E5%BD%A2-1.png" /></p>
<p><img alt="第三正規形-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%B8%89%E6%AD%A3%E8%A6%8F%E5%BD%A2-2.png" /></p>
<ol>
<li><p><strong>まとめ</strong></p>
<p>主キーの関係従属性の排除によって，受注表，商品表，数量表に分割できた．また，主キー以外の関係従属性の排除によって，顧客IDを新しい主キーとした顧客表に分割できた．</p>
</li>
</ol>
<p><img alt="正規化後にどんな表ができるのか" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E6%AD%A3%E8%A6%8F%E5%8C%96%E5%BE%8C%E3%81%AB%E3%81%A9%E3%82%93%E3%81%AA%E8%A1%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%8B.png" /></p>
<p><strong>【具体例2】</strong></p>
<ol>
<li><p><strong>エクセルで表を作成</strong></p>
<p>以下のような表の場合，行を分割し，異なる表と見なす．</p>
</li>
</ol>
<p><img alt="非正規形-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E9%9D%9E%E6%AD%A3%E8%A6%8F%E5%BD%A2-2.png" /></p>
<ol>
<li><p><strong>第一正規化（繰り返し要素の排除）</strong></p>
<p><img alt="第一正規形-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E7%AC%AC%E4%B8%80%E6%AD%A3%E8%A6%8F%E5%BD%A2-2.png" /></p>
</li>
</ol>
</div>
</div>
<div class="section" id="id5">
<h2>02-01. RDBに必要な機能<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin-acid">
<h3>:pushpin: ACID特性<a class="headerlink" href="#pushpin-acid" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>トランザクションを実現するためには，以下の４つの機能が必要である．</p>
<div class="section" id="atomicity">
<h4>・Atomicity<a class="headerlink" href="#atomicity" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>コミットメント制御によって実装される．</p>
</div>
<div class="section" id="consistency">
<h4>・Consistency<a class="headerlink" href="#consistency" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>トランザクションの前後でデータ排他制御によって実装される．</p>
</div>
<div class="section" id="isolation">
<h4>・Isolation<a class="headerlink" href="#isolation" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>排他制御によって実装される．</p>
</div>
<div class="section" id="durability">
<h4>・Durability<a class="headerlink" href="#durability" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>障害回復制御によって実装される．</p>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>02-02. コミットメント制御と障害回復制御<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin-rdb">
<h3>:pushpin: RDBの操作<a class="headerlink" href="#pushpin-rdb" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="コミットメント制御" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%82%B3%E3%83%9F%E3%83%83%E3%83%88%E3%83%A1%E3%83%B3%E3%83%88%E5%88%B6%E5%BE%A1.jpg" /></p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">処理内容</th>
<th align="center">操作名</th>
<th align="center">実装でのメソッド名</th>
<th>システム障害からの回復</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>更新前ログの書き込み</strong></td>
<td align="center">ログの記録</td>
<td align="center"><code>beginTransaction()</code></td>
<td></td>
</tr>
<tr>
<td align="center">↓</td>
<td align="center">↓</td>
<td align="center">↓</td>
<td>⬆︎</td>
</tr>
<tr>
<td align="center"><strong>SQLの実行</strong></td>
<td align="center">Transaction</td>
<td align="center"><code>exec()</code>、<code>flush()</code></td>
<td>⬆︎　<em>Roll back</em>：<code>rollBack()</code></td>
</tr>
<tr>
<td align="center">↓</td>
<td align="center">↓</td>
<td align="center">↓</td>
<td>⬆︎</td>
</tr>
<tr>
<td align="center"><strong>更新後ログの書き込み</strong></td>
<td align="center">Commit</td>
<td align="center"><code>commit()</code>の開始</td>
<td></td>
</tr>
<tr>
<td align="center">↓</td>
<td align="center">↓</td>
<td align="center">↓</td>
<td>⬇︎</td>
</tr>
<tr>
<td align="center">↓</td>
<td align="center">↓</td>
<td align="center">↓</td>
<td>⬇︎　<em>Roll forward</em></td>
</tr>
<tr>
<td align="center">↓</td>
<td align="center">↓</td>
<td align="center">↓</td>
<td>⬇︎</td>
</tr>
<tr>
<td align="center"><strong>更新後ログのDBへの反映</strong></td>
<td align="center">Check Point</td>
<td align="center"><code>commit()</code>の終了</td>
<td></td>
</tr>
</tbody>
</table><p><strong>【実装例】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">try{</span>
<span class="x">    // データベースと接続．</span>
<span class="x">    $db = getDb();</span>

<span class="x">    // 例外処理を有効化．</span>
<span class="x">    $db-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span>
<span class="x">  </span>
<span class="x">    // トランザクションを開始．</span>
<span class="x">    $db-&gt;beginTransaction();</span>
<span class="x">    // いくつかのSQLが実行される．※もし失敗した場合，ERRMODE_EXCEPTIONを実行．</span>
<span class="x">    $db-&gt;exec(&quot;INSERT INTO movie(title, price) VALUES(&#39;ハリポタ&#39;, 2000)&quot;)</span>
<span class="x">    $db-&gt;exec(&quot;INSERT INTO movie(title, price) VALUES(&#39;シスター&#39;, 2000)&quot;)</span>
<span class="x">   </span>
<span class="x">    // トランザクション内の一連のステートメントが成功したら，ログファイルにコミット．</span>
<span class="x">    $db-&gt;commit();</span>

<span class="x">} catch{</span>
<span class="x">    // 例外が発生したらロールバックし，エラーメッセージを出力．</span>
<span class="x">    $db-&gt;rollBack();</span>
<span class="x">    print &quot;失敗しました．：{$e-&gt;getMessage()}&quot;</span>
<span class="x">}  </span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>:pushpin: ログファイルへの更新前ログの書き込み<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
<div class="section" id="id8">
<h3>:pushpin: コミットによるログファイルへの更新前ログへの書き込み<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id9">
<h4>・コミット<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>トランザクション内の一連のステートメントを，ログファイルの更新前ログとして書き込む．</p>
</div>
<div class="section" id="id10">
<h4>・二相コミット<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>コミットを以下の二つの段階に分けて行うこと．ACIDのうち，原子性と一貫性を実装している．</p>
<ol class="simple">
<li><p>他のサイトに更新可能かどうかを確認．</p></li>
<li><p>全サイトからの合意が得られた場合に更新を確定．</p></li>
</ol>
</div>
</div>
<div class="section" id="id11">
<h3>:pushpin: チェックポイントにおけるデータファイルへの書き込み<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>トランザクションの終了後，DBMSは，処理速度を高めるために，ログファイルの更新後ログをいったんメモリ上で管理する．</p>
<p><img alt="DBMSによるメモリとディスクの使い分け" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/DBMS%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%A8%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91.jpg" /></p>
<p>そして，チェックポイントで，ログファイルの更新後ログをディスク上のデータファイルに反映させる．この時，チェックポイントは，自動実行または手動実行で作成する．</p>
<p><img alt="トランザクション" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3.jpg" /></p>
</div>
<div class="section" id="id12">
<h3>:pushpin: システム障害からの回復<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースサーバのソフトウェア障害のこと．例えば，DBMSやOSのトラブル等によりシステム全体が停止する．</p>
<p><img alt="障害回復機能" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E9%9A%9C%E5%AE%B3%E3%81%AE%E9%9A%9C%E5%AE%B3%E5%9B%9E%E5%BE%A9%E6%A9%9F%E8%83%BD.jpg" /></p>
<div class="section" id="id13">
<h4>・ロールバック<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>障害によって，トランザクション内の一連のステートメントがすべて実行されなかった場合に，ログファイルの更新前ログを用いて，トランザクションの開始前の状態に戻す．</p>
</div>
<div class="section" id="id14">
<h4>・ロールフォワード<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>障害によって，トランザクションの終了後に一連のステートメントの更新結果がディスクに反映されなかった場合に，ログファイルの更新後ログを用いて，ディスク上のデータファイルに更新結果を反映させる．</p>
<p><strong>【具体例】</strong></p>
<p>『a』の値を更新するステートメントを含むトランザクションの後に，システムが異常終了した場合，ログファイルの更新後ログ『a = 5』を用いて，ディスク上のデータファイルに更新結果を反映させる．（ロールフォワード）</p>
<p>『b』の値を更新するステートメントを含むトランザクションの途中に，システムが異常終了した場合，ログファイルの更新前ログ『b = 1』を用いて，障害発生前の状態に戻す．（ロールバック）</p>
</div>
</div>
<div class="section" id="id15">
<h3>:pushpin: 媒体障害からの回復<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースサーバのハードウェア障害のこと．例えば，ハードディスクの障害がある．ディスクを初期化／交換した後，バックアップファイルからデータベースを修復し，ログファイルの更新後ログ『a = 5』『b = 1』を用いて，修復できる限りロールフォワードを行う．</p>
<p><img alt="媒体障害の障害回復機能" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E5%AA%92%E4%BD%93%E9%9A%9C%E5%AE%B3%E3%81%AE%E9%9A%9C%E5%AE%B3%E5%9B%9E%E5%BE%A9%E6%A9%9F%E8%83%BD.jpg" /></p>
<p><strong>【具体例】</strong></p>
<p>バックアップファイルの実際のコード</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">-- --------------------------------------------------------</span>
<span class="x">-- Host:                         xxxxx</span>
<span class="x">-- Server version:               10.1.38-MariaDB - mariadb.org binary distribution</span>
<span class="x">-- Server OS:                    Win64</span>
<span class="x">-- HeidiSQL Version:             10.2.0.5611</span>
<span class="x">-- --------------------------------------------------------</span>

<span class="x">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span>
<span class="x">/*!40101 SET NAMES utf8 */;</span>
<span class="x">/*!50503 SET NAMES utf8mb4 */;</span>
<span class="x">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span>
<span class="x">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#39;NO_AUTO_VALUE_ON_ZERO&#39; */;</span>

<span class="x"># データベース作成</span>
<span class="x">-- Dumping database structure for kizukeba_pronami_php</span>
<span class="x">CREATE DATABASE IF NOT EXISTS `kizukeba_pronami_php` /*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci */;</span>
<span class="x">USE `kizukeba_pronami_php`;</span>

<span class="x"># テーブルのデータ型を指定</span>
<span class="x">-- Dumping structure for table kizukeba_pronami_php.mst_staff</span>
<span class="x">CREATE TABLE IF NOT EXISTS `mst_staff` (</span>
<span class="x">  `code` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="x">  `name` varchar(15) COLLATE utf8_unicode_ci NOT NULL,</span>
<span class="x">  `password` varchar(32) COLLATE utf8_unicode_ci NOT NULL,</span>
<span class="x">  PRIMARY KEY (`code`)</span>
<span class="x">) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;</span>

<span class="x"># データを作成</span>
<span class="x">-- Dumping data for table kizukeba_pronami_php.mst_staff: ~8 rows (approximately)</span>
<span class="x">/*!40000 ALTER TABLE `mst_staff` DISABLE KEYS */;</span>
<span class="x">INSERT INTO `mst_staff` (`code`, `name`, `password`) VALUES</span>
<span class="x">    (1, &#39;秦基博&#39;, &#39;xxxxxxx&#39;),</span>
<span class="x">    (2, &#39;藤原基央&#39;, &#39;xxxxxxx&#39;);</span>
<span class="x">/*!40000 ALTER TABLE `mst_staff` ENABLE KEYS */;</span>

<span class="x">/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, &#39;&#39;) */;</span>
<span class="x">/*!40014 SET FOREIGN_KEY_CHECKS=IF(@OLD_FOREIGN_KEY_CHECKS IS NULL, 1, @OLD_FOREIGN_KEY_CHECKS) */;</span>
<span class="x">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id16">
<h2>02-03. 排他制御<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id17">
<h3>:pushpin: なぜ排他制御が必要か<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="排他制御-1" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1-1.png" /></p>
<div class="section" id="id18">
<h4>・排他制御を行った結果<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><img alt="排他制御-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1-2.png" /></p>
</div>
</div>
<div class="section" id="id19">
<h3>:pushpin: 排他制御におけるロックの種類<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="排他制御-3" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1-3.gif" /></p>
<ul class="simple">
<li><p><strong>共有ロック</strong></p></li>
</ul>
<p>CRUDのRead以外の操作を実行不可能にする．データのRead時に，他者によってUpdateされたくない場合に用いる．「共有」の名の通り，共有ロックされているデータに対して，他の人も共有ロックを行うことができる．</p>
<div class="section" id="id20">
<h4>・専有ロック<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>CRUDの全ての操作を実行不可能にする．データのUpdate時に，他者によってUpdateもReadもされたくない場合に用いる．</p>
</div>
</div>
<div class="section" id="id21">
<h3>:pushpin: ロックの粒度<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="ロックの粒度" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E7%B2%92%E5%BA%A6-1.png" /></p>
<p>DB ＞ テーブル ＞ レコード ＞ カラム の順に，粒度は大きい．ロックの粒度が細かければ，トランザクションの同時実行性が高くなって効率は向上する（複数の人がDBに対して作業できる）．しかし，ロックの粒度を細かくすればするほど，それだけデータベース管理システムのCPU負荷は大きくなる．</p>
<p><img alt="ロックの粒度-2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%AD%E3%83%83%E3%82%AF%E3%81%AE%E7%B2%92%E5%BA%A6-2.jpg" /></p>
</div>
<div class="section" id="id22">
<h3>:pushpin: デッドロック現象<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数のトランザクションが，互いに他者が使いたいデータをロックしてしまい，お互いのロック解除を待ち続ける状態のこと．もう一方のレコードのロックが解除されないと，自身のレコードのロックを解除できない時，トランザクションが停止する．</p>
<div class="section" id="id23">
<h4>・共有ロックしたデータを共有ロック<a class="headerlink" href="#id23" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
<div class="section" id="id24">
<h4>・共有ロックしたデータを専有ロック<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
<div class="section" id="id25">
<h4>・専有ロックしたデータを共有ロック<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
<div class="section" id="id26">
<h4>・専有ロックしたデータを専有ロック<a class="headerlink" href="#id26" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><img alt="Null" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF.gif" /></p>
</div>
</div>
</div>
<div class="section" id="create">
<h2>03-01. <code class="docutils literal notranslate"><span class="pre">create</span></code>によるテーブルの作成<a class="headerlink" href="#create" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 注文テーブル作成</span>
<span class="x">CREATE TABLE order_data (</span>

<span class="x">    // Primary Key制約</span>
<span class="x">    order_id INT(10) PRIMARY KEY COMMENT &#39;注文ID&#39;,</span>

<span class="x">    // Not Null制約</span>
<span class="x">    order_kbn INT(3) NOT NULL COMMENT &#39;注文区分&#39;,</span>
<span class="x">    system_create_date_time DATETIME NOT NULL COMMENT &#39;システム登録日時&#39;,</span>
<span class="x">    system_update_date_time DATETIME NOT NULL COMMENT &#39;システム更新日時&#39;,</span>
<span class="x">    delete_flg INT(1) DEFAULT 0 NOT NULL COMMENT &#39;0：通常，1：削除済&#39;,</span>
<span class="x">  </span>
<span class="x">    // 複合Primary Key制約（これを指定する場合，上記のPrimary Key制約の記述は不要）</span>
<span class="x">    PRIMARY KEY(order_id, order_kbn)</span>
<span class="x">  </span>
<span class="x">    // 参照制約キー</span>
<span class="x">    FOREIGN KEY order_kbn REFERENCES order_kbn_data</span>
<span class="x">)</span>
</pre></div>
</div>
<div class="section" id="pushpin-primary-key">
<h3>:pushpin: Primary key（主キー）制約と複合主キー制約<a class="headerlink" href="#pushpin-primary-key" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>テーブルの中で，Rowデータを一意に特定できる値を『主キー』の値と呼ぶ．</p>
<p><img alt="主キー" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E4%B8%BB%E3%82%AD%E3%83%BC.jpg" /></p>
<p>主キーは複数設定することができ，複合主キーの場合，片方のフィールドの値が異なれば，異なる主キーとして見なされる．以下のように，ユーザIDと期間開始日付を複合主キーとすると，一人のユーザが複数の期間をもつ場合に対応できる．</p>
<table border="1" class="docutils">
<thead>
<tr>
<th><em>user_id</em></th>
<th><em>period_start_date</em></th>
<th>period_end_date</th>
<th>fee_yen</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>1</em></td>
<td><em>2019-04-03</em></td>
<td>2019-05-03</td>
<td>200</td>
</tr>
<tr>
<td><em>1</em></td>
<td><em>2019-10-07</em></td>
<td>2019-11-07</td>
<td>400</td>
</tr>
<tr>
<td><em>2</em></td>
<td><em>2019-10-11</em></td>
<td>2019-11-11</td>
<td>200</td>
</tr>
</tbody>
</table></div>
<div class="section" id="pushpin-not-null">
<h3>:pushpin: Not Null制約<a class="headerlink" href="#pushpin-not-null" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>レコードに挿入される値のデータ型を指定しておくことによって，データ型不一致やNullのための例外処理を実装しなくてもよくなる．</p>
</div>
<div class="section" id="pushpin-foreign-key">
<h3>:pushpin: Foreign key（外部キー）と参照制約<a class="headerlink" href="#pushpin-foreign-key" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数のテーブルを関連付けるために用いられるカラムのことをForeign key（外部キー）という．外部キーの参照先のテーブルには，外部キーの値と同じ値のカラムが存在していなければならない（参照制約）．参照制約を行うと，以下の2つが起こる．</p>
<div class="section" id="id27">
<h4>・親テーブルに存在しない値は，子テーブルに登録できない．<a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
<div class="section" id="id28">
<h4>・親テーブルで参照される値は，子テーブルからは削除できない．<a class="headerlink" href="#id28" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><img alt="外部キー" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC.png" /></p>
</div>
</div>
<div class="section" id="pushpin-stored-procedure">
<h3>:pushpin: stored procedure<a class="headerlink" href="#pushpin-stored-procedure" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>あらかじめ一連のSQL文をデータベースに格納しておき，Call文で呼び出す方式．</p>
<p><img alt="p325" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/p325.gif" /></p>
<p><strong>【実装例】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// PROCEDUREを作成し，データベースへ格納しておく．</span>
<span class="x">CREATE PROCEDURE SelectContact AS　</span>
<span class="x">  SELECT CustomerID, CompanyName, ContactName, Phone</span>
<span class="x">  FROM Customers</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// PROCEDUREを実行</span>
<span class="x">EXEC SelectContact</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="insert">
<h2>03-02. <code class="docutils literal notranslate"><span class="pre">insert</span></code>によるデータ行の入力<a class="headerlink" href="#insert" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><strong>【スクラッチ開発による実装例】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// $_POSTを用いて，送信されたpostメソッドのリクエストを受け取り，属性から各値を取得</span>
<span class="x">$staff_name = $_POST[&#39;name&#39;];</span>
<span class="x">$staff_pass = $_POST[&#39;pass&#39;];</span>

<span class="x">// HTMLとして変数の内容を出力する際，「&lt;」「&gt;」などの特殊文字をエスケープ（無害化）</span>
<span class="x">$staff_name = htmlspecialchars($staff_name, ENT_QUOTES, &#39;UTF-8&#39;);</span>
<span class="x">$staff_pass = htmlspecialchars($staff_pass, ENT_QUOTES, &#39;UTF-8&#39;);</span>

<span class="x">// データベースと接続（イコールの間にスペースを入れるとエラーになる）</span>
<span class="x">$dsn = &#39;mysql:dbname=kizukeba_pronami_php;</span>
<span class="x">host=kizukebapronamiphp</span>
<span class="x">charaset=UTF-8&#39;;</span>
<span class="x">$user = &#39;root&#39;;</span>
<span class="x">$password = &#39;&#39;;</span>
<span class="x">$dbh = new PDO($dsn, $user, $password);</span>
<span class="x">$dbh-&gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);</span>

<span class="x">// 列名と値を指定してINSERT</span>
<span class="x">$sql=&#39;INSERT INTO mst_staff (name,password) VALUES (?,?)&#39;;</span>
<span class="x">$stmt = $dbh-&gt;prepare($sql);</span>

<span class="x">// 配列に値を格納（格納する値の順番と，SQLでの引数の順番は，合わせる必要がある）</span>
<span class="x">$data[] = $staff_name;</span>
<span class="x">$data[] = $staff_pass;</span>

<span class="x">// SQLを実行</span>
<span class="x">$stmt-&gt;execute($data);</span>

<span class="x">// データベースとの接続を切断</span>
<span class="x">$dbh = null;</span>
</pre></div>
</div>
</div>
<div class="section" id="migration">
<h2>03-03. <code class="docutils literal notranslate"><span class="pre">migration</span></code>によるデータベースの更新<a class="headerlink" href="#migration" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>マイグレーションファイルと呼ばれるスクリプトファイルを作成し，テーブルの新規作成やカラムの追加はこのスクリプトファイルに記述していく．</p>
<ol class="simple">
<li><p>誰かが以下のMigrationファイルをmaster別名にPush</p></li>
<li><p>Migrationファイルをローカル環境にPull</p></li>
<li><p>データベース更新バッチを実行し，ローカル環境のDBスキーマとデータを更新</p></li>
</ol>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">namespace Migration</span>

<span class="x">class ItemQuery</span>
<span class="x">{</span>
<span class="x">    // 列名と値を指定してINSERT</span>
<span class="x">    public static function insert()</span>
<span class="x">    {</span>
<span class="x">        return &quot;INSERT INTO item_table VALUES(1, &#39;商品A&#39;, 1000, &#39;2019-07-24 07:07:07&#39;);&quot;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
</div>
<div class="section" id="select">
<h2>04-01. <code class="docutils literal notranslate"><span class="pre">select</span></code>によるデータセットの取得<a class="headerlink" href="#select" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id29">
<h3>:pushpin: 実装例で用いた略号<a class="headerlink" href="#id29" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>C</strong>：column（列）</p>
<p><strong>R</strong>：record（行）</p>
<p><strong>T</strong>：table</p>
</div>
<div class="section" id="pushpin-sql">
<h3>:pushpin: SQLの処理の順番<a class="headerlink" href="#pushpin-sql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">from =&gt; join =&gt; where =&gt; group by =&gt; having =&gt; select =&gt; order by</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-join">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">join</span></code>（結合）<a class="headerlink" href="#pushpin-join" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="内部結合のベン図" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E5%86%85%E9%83%A8%E7%B5%90%E5%90%88%E3%81%AE%E3%83%99%E3%83%B3%E5%9B%B3.jpg" /></p>
</div>
<div class="section" id="pushpin-left-join">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">join</span></code>（左外部結合）<a class="headerlink" href="#pushpin-left-join" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>『users』テーブルと『items』テーブルの商品IDが一致しているデータと，元となる『users』テーブルにしか存在しないデータが，セットで取得される．</p>
<p><img alt="LEFT_JOIN" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/LEFT_JOIN.png" /></p>
</div>
<div class="section" id="pushpin-inner-join">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">inner</span> <span class="pre">join</span></code>（内部結合）<a class="headerlink" href="#pushpin-inner-join" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>基本情報技術者試験では，内部結合（A∩B）しか出題されない．</p>
<div class="section" id="where">
<h4>・内部結合に<code class="docutils literal notranslate"><span class="pre">where</span></code>を用いる場合<a class="headerlink" href="#where" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>2つの<code class="docutils literal notranslate"><span class="pre">where</span></code>文が，<code class="docutils literal notranslate"><span class="pre">AND</span></code>で結びつけられている時，まず一つ目の<code class="docutils literal notranslate"><span class="pre">where</span></code>を満たすレコードを取得した後，取得したレコードの中から，二つ目の<code class="docutils literal notranslate"><span class="pre">where</span></code>を満たすレコードを取得する．</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 『カラム』だけでなく，どの『表』なの物なのかも指定</span>
<span class="x">select T1.C1,</span>
<span class="x">    // 複数の表を指定</span>
<span class="x">    from T1, T2,</span>
<span class="x">    // まず，1つ目のフィールドと2つ目のフィールドが同じレコードを取得．</span>
<span class="x">    where R1 = R2 and  </span>
<span class="x">    // 次に，上記で取得したレコードのうち，次の条件も満たすレコードのみを取得．</span>
<span class="x">    R2 = R3  </span>
</pre></div>
</div>
</div>
<div class="section" id="inner-join-on">
<h4>・内部結合に<code class="docutils literal notranslate"><span class="pre">inner</span> <span class="pre">join</span> <span class="pre">on</span></code>を用いる場合（本試験では出題されない）<a class="headerlink" href="#inner-join-on" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 『カラム』だけでなく，どの『表』なの物なのかも指定</span>
<span class="x">select T1.C1,</span>
<span class="x">    // 複数の表を指定</span>
<span class="x">    from T1  </span>
<span class="x">    inner join T2</span>
<span class="x">        // 2つ目の表の『レコード』と照合</span>
<span class="x">        on T1.C1 = T2.C2  </span>
<span class="x">    inner join T3</span>
<span class="x">        // 3つ目の表の『レコード』と照合</span>
<span class="x">        on T1.C1 = T3.C3  </span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id30">
<h3>:pushpin: 集合関数まとめ<a class="headerlink" href="#id30" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="sum">
<h4>・<code class="docutils literal notranslate"><span class="pre">sum()</span></code><a class="headerlink" href="#sum" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，『フィールド』の合計を取得</span>
<span class="x">select sum(C)  </span>
<span class="x">    from T;</span>
</pre></div>
</div>
</div>
<div class="section" id="avg">
<h4>・<code class="docutils literal notranslate"><span class="pre">avg()</span></code><a class="headerlink" href="#avg" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，『フィールド』の平均値を取得</span>
<span class="x">select avg(C)  </span>
<span class="x">    from T;</span>
</pre></div>
</div>
</div>
<div class="section" id="min">
<h4>・<code class="docutils literal notranslate"><span class="pre">min()</span></code><a class="headerlink" href="#min" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，『フィールド』の最小値を取得</span>
<span class="x">select min(C)</span>
<span class="x">    from T;</span>
</pre></div>
</div>
</div>
<div class="section" id="max">
<h4>・<code class="docutils literal notranslate"><span class="pre">max()</span></code><a class="headerlink" href="#max" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，『フィールド』の最大値を取得</span>
<span class="x">select max(C)</span>
<span class="x">    from T;</span>
</pre></div>
</div>
</div>
<div class="section" id="count">
<h4>・<code class="docutils literal notranslate"><span class="pre">count()</span></code><a class="headerlink" href="#count" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，『フィールド』の個数を取得</span>
<span class="x">select count(C)</span>
<span class="x">    from T;</span>
</pre></div>
</div>
<p><strong>※消去法の小技：集合関数を入れ子状にはできない</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 集合関数を集合関数の中に入れ子状にすることはできない．</span>
<span class="x">select avg(sum(C))</span>
<span class="x">    from T;</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，値無しも含む『フィールド』を取得</span>
<span class="x">select count(*)</span>
<span class="x">    from T;</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，値無しを除いた『フィールド』を取得</span>
<span class="x">select count(C);</span>

<span class="x">// 上に同じ</span>
<span class="x">select count(all C);</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// 指定したカラムで，重複した『フィールド』を除く全ての『フィールド』を取得 </span>
<span class="x">select count(distinct C);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pushpin-in">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">in</span></code><a class="headerlink" href="#pushpin-in" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>【IN句を使用しなかった場合】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">SELECT * FROM fruit WHERE name = &quot;みかん&quot; OR name = &quot;りんご&quot;;</span>
</pre></div>
</div>
<p><strong>【IN句を使用した場合】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">SELECT * FROM fruit WHERE name IN(&quot;みかん&quot;,&quot;りんご&quot;);</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-group-by">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code><a class="headerlink" href="#pushpin-group-by" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id31">
<h4>・集合関数との組み合わせ<a class="headerlink" href="#id31" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>カラムをグループ化し，フィールドの値を計算する．</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select C1, avg(C2)</span>
<span class="x">    from T</span>
<span class="x">    // 指定したカラムをグループ化し，フィールドの値を合計する．</span>
<span class="x">    group by C;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pushpin-having">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">having</span></code><a class="headerlink" href="#pushpin-having" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各句の処理の順番から考慮して，<code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code>でグループ化した結果から，<code class="docutils literal notranslate"><span class="pre">having</span></code>で『フィールド』を取得．<code class="docutils literal notranslate"><span class="pre">select</span></code>における集計関数が，<code class="docutils literal notranslate"><span class="pre">having</span></code>における集計関数の結果を指定していることに注意せよ．</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// havingによる集計結果を指定して出力．</span>
<span class="x">select C1, count(C2) </span>
<span class="x">    from T</span>
<span class="x">    group by C2</span>
<span class="x">    // グループ化した結果を集計し，２個以上の『フィールド』を取得</span>
<span class="x">    having count(C2) &gt;= 2; </span>
</pre></div>
</div>
<p>※以下の場合，<code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span> <span class="pre">+</span> <span class="pre">having</span></code>を使っても，<code class="docutils literal notranslate"><span class="pre">where</span></code>を使っても，同じ出力結果になる．</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select C</span>
<span class="x">    from T</span>
<span class="x">    group by C</span>
<span class="x">    having R;</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select C</span>
<span class="x">    from T</span>
<span class="x">    where R</span>
<span class="x">    group by C;</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-sub-query">
<h3>:pushpin: sub-query<a class="headerlink" href="#pushpin-sub-query" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>掛け算と同様に，括弧内から先に処理を行う．</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// Main-query</span>
<span class="x">select * from T</span>
<span class="x">    // Sub-query</span>
<span class="x">    where C != (select max(C) from T);</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-inany">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">in</span></code>と<code class="docutils literal notranslate"><span class="pre">any</span></code><a class="headerlink" href="#pushpin-inany" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="in">
<h4>・<code class="docutils literal notranslate"><span class="pre">in</span></code><a class="headerlink" href="#in" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>指定した値と同じ『フィールド』を取得</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // 指定したカラムで，指定した値の『フィールド』を取得</span>
<span class="x">    where C in (xxx, xxx, ...);</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // 指定したカラムで，指定した値以外の『フィールド』を取得</span>
<span class="x">    where C not in (R1, R2, ...);</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // フィールドを指定の値として用いる</span>
<span class="x">    where C not in (</span>
<span class="x">        // 指定したカラムで，『フィールド』を取得</span>
<span class="x">        select C from T where R &gt;= 160);</span>
</pre></div>
</div>
</div>
<div class="section" id="any">
<h4>・<code class="docutils literal notranslate"><span class="pre">any</span></code><a class="headerlink" href="#any" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>書き方が異なるだけで，<code class="docutils literal notranslate"><span class="pre">in</span></code>と同じ出力</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    where C = any(xxx, xxx, xxx);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pushpin-view">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">view</span></code><a class="headerlink" href="#pushpin-view" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ビューとはある表の特定のカラムや指定した条件に合致するレコードなどを取り出した仮想の表．また，複数の表を結合したビューを作成できる．ビューを作成することによりユーザに必要最小限のカラムやレコードのみにアクセスさせる事ができ，また結合条件を指定しなくても既に結合された表にアクセスできる．
⇒よくわからん…</p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">create view T as</span>
<span class="x">    select * from ...;</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-wildcard">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">wildcard</span></code><a class="headerlink" href="#pushpin-wildcard" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // 任意の文字（文字無しも含まれる）</span>
<span class="x">    where C like &#39;%営業&#39;;</span>
</pre></div>
</div>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // 任意の一文字</span>
<span class="x">    where C like &#39;_営業&#39;;</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-between">
<h3>:pushpin: <code class="docutils literal notranslate"><span class="pre">between</span></code><a class="headerlink" href="#pushpin-between" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">select * from T</span>
<span class="x">    // 指定したカラムで，1以上10以下の『フィールド』を取得</span>
<span class="x">    between 1 and 10;</span>
</pre></div>
</div>
</div>
<div class="section" id="id32">
<h3>:pushpin: 変数<a class="headerlink" href="#id32" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span>/* 括弧内に値を設定してください */
SET @STAFF_NAME = {パラメータ値};
SET @STAFF_ID = {パラメータ値};

UPDATE `mst_staff`
  SET `staff_name` = @STAFF_NAME,
  WHERE `staff_id` = @STAFF_ID;
</pre></div>
</div>
</div>
<div class="section" id="id33">
<h3>:pushpin: プレースホルダー<a class="headerlink" href="#id33" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プリペアードステートメントともいう．</p>
</div>
</div>
<div class="section" id="fetch">
<h2>04-02. <code class="docutils literal notranslate"><span class="pre">fetch</span></code>によるデータ行の取得<a class="headerlink" href="#fetch" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="pushpin-php">
<h3>:pushpin: PHPの場合<a class="headerlink" href="#pushpin-php" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>DBで取得したデータをプログラムに一度に全て送信してしまうと，プログラム側のメモリを圧迫してしまう．そこで，fetchで少しずつ取得する．</p>
<p><strong>【実装例】</strong></p>
<div class="highlight-PHP notranslate"><div class="highlight"><pre><span></span><span class="x">// select文を定義して実行．</span>
<span class="x">$sql = &quot;SELECT * FROM doraemon_characters&quot;;</span>
<span class="x">$stmt = $dbh-&gt;prepare($sql);</span>
<span class="x">$stmt-&gt;execute()</span>

<span class="x">// 全てのデータ行を取得</span>
<span class="x">$data = $stmt-&gt;fetchAll();</span>

<span class="x">// 出力</span>
<span class="x">print_r($data);</span>

<span class="x">// カラム名と値の連想配列として取得できる．</span>
<span class="x">Array</span>
<span class="x">(</span>
<span class="x">    [0] =&gt; Array</span>
<span class="x">    (</span>
<span class="x">        [id] =&gt; 1</span>
<span class="x">        [name] =&gt; のび太</span>
<span class="x">        [gender] =&gt; man</span>
<span class="x">        [type] =&gt; human</span>
<span class="x">    )</span>
<span class="x">    [1] =&gt; Array</span>
<span class="x">    (</span>
<span class="x">        [id] =&gt; 2</span>
<span class="x">        [name] =&gt; ドラえもん</span>
<span class="x">        [gender] =&gt; man</span>
<span class="x">        [type] =&gt; robot</span>
<span class="x">    )</span>
<span class="x">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pushpin-java">
<h3>:pushpin: Javaの場合<a class="headerlink" href="#pushpin-java" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>PHPとは異なり，変数定義に『$』は用いないことに注意．</p>
<p><strong>【実装例】</strong></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>// select文を定義して実行．
String sql = &quot;SELECT * FROM doraemon_characters&quot;;
ResultSet result statement.executeQuery();

// 全てのデータ行を取得
while(result.next()){
    System.out.println(result.getInt(&quot;id&quot;));
    System.out.println(result.getString(&quot;name&quot;));
    System.out.println(result.getString(&quot;gender&quot;));
    System.out.println(result.getString(&quot;typeL&quot;));
}

// カラム名と値の連想配列として取得できる．
ここに出力結果コードを書く．
</pre></div>
</div>
</div>
</div>
<div class="section" id="id34">
<h2>05-01. レコードの突き合わせ<a class="headerlink" href="#id34" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id35">
<h3>:pushpin: 突き合わせ処理とは<a class="headerlink" href="#id35" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ビジネスの基盤となるマスタデータ（商品データ，取引先データなど）と，日々更新されるトランザクションデータ（販売履歴，入金履歴など）を突き合わせ，新しいデータを作成する処理のこと．</p>
<p><img alt="マッチング処理_1" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86_1.PNG" /></p>
</div>
<div class="section" id="id36">
<h3>:pushpin: 突き合わせ処理のアルゴリズム<a class="headerlink" href="#id36" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><img alt="マッチング処理_4" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86_4.png" /></p>
<p><strong>【突き合わせ処理の具体例】</strong></p>
<p>とある生命保険会社では，顧客の保険契約データを契約マスタテーブルで，またそれとは別に，保険契約データの変更点（異動事由）を異動トランザクションテーブルで，管理している．毎日，契約マスタテーブルと異動トランザクションテーブルにおける前日レコードを突き合わせ，各契約の異動事由に応じて，変更後契約データとして，新契約マスタテーブルに挿入する．</p>
<p><img alt="マッチング処理_2" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86_2.PNG" /></p>
<p>前処理として，契約マスタデータと異動トランザクションデータに共通する識別子が同じ順番で並んでいる必要がある．</p>
<ol class="simple">
<li><p>契約マスタデータの1行目と，異動トランザクションデータの1行目の識別子を突き合わせる．『契約マスタデータ = 異動トランザクションデータ』の時，異動トランザクションデータを基に契約マスタデータを更新し，それを新しいデータとして変更後契約マスタデータに挿入する．</p></li>
<li><p>契約マスタデータの2行目と，異動トランザクションデータの2行目の識別子を突き合わせる．『マスタデータ &lt; トランザクションデータ』の場合，マスタデータをそのまま変更後マスタテーブルに挿入する．</p></li>
<li><p>マスタデータの3行目と，固定したままのトランザクションデータの2行目の識別子を突き合わせる．『マスタデータ = トランザクションデータ』の時，トランザクションデータを基にマスタデータを更新し，それを変更後データとして変更後マスタテーブルに挿入する．</p></li>
<li><p>『契約マスタデータ &lt; 異動トランザクションデータ』になるまで，データを突き合わせる．</p></li>
<li><p>最終的に，変更後マスタテーブルは以下の通りになる．</p></li>
</ol>
<p><img alt="マッチング処理_3" src="https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/markdown/image/%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0%E5%87%A6%E7%90%86_3.png" /></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="MalwareAndCyberAttacks.html" class="btn btn-neutral float-right" title="Malwareとサイバー攻撃" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="CQRS.html" class="btn btn-neutral float-left" title="CQRS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, hiroki

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>